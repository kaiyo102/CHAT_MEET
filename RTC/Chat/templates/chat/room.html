{% extends "chat/base.html" %}

{% block title %}Chat room | {% endblock %}

{% block content %}
<div class="container">
    <div class="left-column rounded shadow-sm">
        {% if rooms %}
            {% for room in rooms %}
                <div class="group-list">
                    {% for user in room.users.all %}
                        {% if user.username != request.user.username and user.username != receiver.username %}
                            <div class="d-flex" style="width: 100%; height: 70px; align-items: center; padding: 5px;">
                                <img src="{{ user.profile_picture.url | default:'media/profile_pictures/default.jpg' }}" 
                                        alt="Profile Picture" 
                                        class="img-fluid rounded-circle" 
                                        style="width: 40px; height: 40px; object-fit: cover; margin-right: 15px;">
                                <a href="{% url 'create_room' user.username %}" style="
                                    background-color: rgb(0, 48, 131);
                                    text-decoration: none;
                                    padding: 10px;
                                    color: white;
                                    text-align: center;
                                    border-radius: 5px; 
                                    font-weight: bold;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    height: 100%;
                                    width: calc(100% - 55px); /* T√≠nh to√°n width cho link (d·ª±a tr√™n k√≠ch th∆∞·ªõc c·ªßa ·∫£nh v√† padding) */
                                ">
                                    {{ user.username }}
                                </a>
                            </div>
                        {% elif user.username == receiver.username %}
                            <div class="d-flex" style="width: 100%; height: 70px; align-items: center; padding: 5px;">
                                <img src="{{ user.profile_picture.url | default:'media/profile_pictures/default.jpg' }}" 
                                        alt="Profile Picture" 
                                        class="img-fluid rounded-circle" 
                                        style="width: 40px; height: 40px; object-fit: cover; margin-right: 15px;">
                                <a href="{% url 'create_room' user.username %}" style="
                                    background-color: rgb(0, 24, 80);
                                    text-decoration: none;
                                    padding: 10px;
                                    color: white;
                                    text-align: center;
                                    border-radius: 5px; 
                                    font-weight: bold;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    height: 100%;
                                    width: calc(100% - 55px); /* T√≠nh to√°n width cho link (d·ª±a tr√™n k√≠ch th∆∞·ªõc c·ªßa ·∫£nh v√† padding) */
                                ">
                                    {{ user.username }}
                                </a>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            <div class="">B·∫°n ch∆∞a c√≥ b·∫•t k·ª≥ cu·ªôc tr√≤ chuy·ªán n√†o!</div>
        {% endif %}
    </div> 
    <div class="main-content container mt-0" style="max-width: 100%; display: flex; flex-direction: column;">
        <div id="chatBox" class="border p-3 mb-2 rounded shadow-sm"
            style="flex-grow: 1; overflow-y: auto; max-width: 100%;background-color: lightblue;">  
            {% for message in messages %}
                <div class="d-flex {% if message.sender == sender %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
                {% if message.sender == sender %}
                    <!-- Tin nh·∫Øn c·ªßa b·∫°n (Hi·ªÉn th·ªã b√™n ph·∫£i) -->
                    <div class="text-end">
                    <p class="mb-1"><strong>{{ message.sender.username }}:</strong></p>
                    {% if message.image %}
                        <img src="{{ message.image }}" alt="Profile Picture"
                            style="width: auto; max-width: 400px; height: auto; max-height:700px; margin-right: 10px;">
                    {% endif %}
                    {% if message.file %}
                        <a href="{{ message.file }}" download class="d-block text-decoration-none text-primary mb-2">
                        üìÇ T·∫£i t·ªáp ƒë√≠nh k√®m
                        </a>
                    {% endif %}
                    {% if message.content %}
                        <p class="p-2 bg-primary text-white rounded" style="word-wrap: break-word;">
                        {{ message.content }}
                        </p>
                    {% endif %}
                    </div>
                {% else %}
                    <!-- Tin nh·∫Øn c·ªßa b·∫°n b√® (Hi·ªÉn th·ªã b√™n tr√°i) -->
                    <div class="d-flex align-items-start">
                    <img src="{{ receiver.profile_picture.url }}" alt="Profile Picture"
                        class="img-fluid rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
                    <div>
                        <p class="mb-1"><strong>{{ message.sender.username }}:</strong></p>
                        {% if message.image %}
                        <img src="{{ message.image }}" alt="Profile Picture"
                            style="width: auto; max-width: 400px; height: auto; max-height:700px; margin-right: 10px;">
                        {% endif %}
                        {% if message.file %}
                        <a href="{{ message.file }}" download class="d-block text-decoration-none text-primary mb-2">
                            üìÇ T·∫£i t·ªáp ƒë√≠nh k√®m
                        </a>
                        {% endif %}
                        {% if message.content %}
                        <p class="p-2 bg-primary text-white rounded" style="word-wrap: break-word;">
                            {{ message.content }}
                        </p>
                        {% endif %}
                    </div>
                    </div>
                {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <div class="chat-input-container">
            <div class="input-group">
                <div class="d-flex align-items-center gap-3">
                    <label class="btn btn-icon" for="chat-image-input">
                        <i class="fas fa-image fa-lg" style="color:rgb(255, 255, 255); cursor: pointer;"></i>
                    </label>
                    <input id="chat-image-input" type="file" accept="image/*" style="display: none;">
                                        
                    <label class="btn btn-icon" for="chat-file-input">
                        <i class="fas fa-paperclip fa-lg" style="color:rgb(255, 255, 255); cursor: pointer;"></i>
                    </label>
                    <input id="chat-file-input" type="file" style="display: none;">
                </div>
                <input type="text" id="chat-message-input" class="form-control" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <input id="sender_username" type="hidden" value="{{ request.session.username }}">
                <div class="input-group-append">
                    <button class="btn btn-icon" id="chat-message-submit" title="G·ª≠i tin nh·∫Øn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="btn btn-icon" id="call-button" onclick="startCall(), acceptOfferShare()" title="G·ªçi video">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="btn btn-icon" id="share-button" onclick="startShareScreen(), acceptOfferShare()" title="Chia s·∫ª m√†n h√¨nh">
                        <i class="fas fa-desktop"></i>
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    <div class="right-column container mt-0 pt-1" style="max-width: 300px; flex-direction: column;">
        <div class="chat-container">
            <div class="chat-header">
                {% for message in messages %}
                    {% if message.image %}
                        <img src="{{ message.image }}" alt="Profile Picture"
                            style="width: auto; max-width: 100px; height: auto; max-height:auto; margin-right: 10px;">
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    <div id="customModal" class="position-fixed start-50 translate-middle d-none"
        style="top: 350px; width: 1400px; height: 580px; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.3); border-radius: 10px;">
        
        <div id="offer-container" style="width:100%; height:450px; display:none; justify-content: center; align-items: center;">
            <div style="width: 40%; height: auto; padding: 5px; margin: auto; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <img src="{{ receiver.profile_picture.url | default:'media/profile_pictures/default.jpg' }}" 
                     alt="Profile Picture" 
                     class="img-fluid rounded-circle" 
                     style="width: 300px; height: 300px; object-fit: cover;">
                
                <div style="background-color: pink; padding: 10px; color: black; text-align: center; border-radius: 5px; font-weight: bold; font-size:30px; width:100%;">
                    {{ receiver.username }}
                </div>
                
                <button class="btn btn-danger" style="width: 100%;" onclick="acceptOfferShare()">Ch·∫•p nh·∫≠n</button>
                <button class="btn btn-danger" style="width: 100%;" onclick="hideModal(), endCall()">T·ª´ ch·ªëi</button>
            </div>
        </div>

        <div id="video-container" style="display:none;">
            <div id="video-call-container">
                <video id="localVideo" autoplay mute poster controls allowfullscreen allow="autoplay; picture-in-picture" style="width: 49%; height:500px; border: 2px solid blue;"></video>
                <video id="remoteVideo" autoplay poster controls allowfullscreen allow="autoplay; picture-in-picture" style="width: 49%; height:500px; border: 2px solid red;"></video>
            </div>
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-danger rounded-circle" style="width: 50px; height: 50px;" id="end-call-button" onclick="hideModal(), endCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
                <button class="btn btn-primary rounded-circle" style="width: 50px; height: 50px;" id="call-button" onclick="startCall(), acceptOfferShare()">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="btn btn-primary rounded-circle" style="width: 50px; height: 50px;" id="share-button" onclick="startShareScreen(), acceptOfferShare()">
                    <i class="fas fa-desktop"></i>
                </button>
            </div>
        </div>
    </div>
</div>
<script>
// Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
window.onload = function() {
    let chatBox = document.getElementById("chatBox");
    chatBox.scrollTop = chatBox.scrollHeight;
};
// Thi·∫øt l·∫≠p n√∫t enter l√† n√∫t g·ª≠i tin nh·∫Øn v√† g·ª≠i file
document.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh
        document.getElementById("chat-message-submit").click(); // K√≠ch ho·∫°t n√∫t g·ª≠i
    }
});


// T·∫°o k·∫øt n·ªëi WebRTC
const peer = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});
// Thi·∫øt l·∫≠p bi·∫øn
let localStream;
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
let iceCandidateQueue = []; // H√†ng ƒë·ª£i ICE candidate l∆∞u tr·ªØ m·ªôt danh s√°ch ICE candidate (th√¥ng tin k·∫øt n·ªëi nh∆∞ ƒë·ªãa ch·ªâ Ip, c·ªïng)

// Khi c√≥ lu·ªìng video t·ª´ user kh√°c
peer.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
};

// Khi c√≥ ICE Candidate m·ªõi
peer.onicecandidate = (event) => {
    if (event.candidate) {
    chatSocket.send(JSON.stringify({
        type: "ice_candidate",
        candidate: event.candidate,
        sender: senderUsername
    }));
    }
};
// C√°c h√†m hi·ªÉn th·ªã v√† ·∫©n khung h√¨nh g·ªçi, nh·∫≠n call
function showOfferShare() {
    showModal()
    document.getElementById("offer-container").style.display = "block";
}

function acceptOfferShare() {
    showModal()
    document.getElementById("offer-container").style.display = "none";
    document.getElementById("video-container").style.display = "block";
}

function refuseOffderShare() {
    hideModal()
    endCall()
    endcallButton.click()
}

function showModal() {
    document.getElementById("customModal").classList.remove("d-none");
}

function hideModal() {
    document.getElementById("customModal").classList.add("d-none");
}

// √Åp d·ª•ng c√°c ICE candidate trong h√†ng ƒë·ª£i sau khi SDP s·∫µn s√†ng
async function applyQueuedIceCandidates() {
    while (iceCandidateQueue.length > 0) {
    const candidate = iceCandidateQueue.shift();
    await peer.addIceCandidate(candidate)
        .catch(error => console.error("L·ªói th√™m queued ICE candidate:", error));
    }
}

// L·∫•y c√°c bi·∫øn t·ª´ template
const roomName = "{{ room_name }}";
const senderUsername = document.getElementById("sender_username").value;
const sender = {
    id: "{{ sender.id }}",
    username: "{{ sender.username }}",
};
const receiver = {
    id: "{{ receiver.id }}",
    username: "{{ receiver.username }}",
}
// Kh·ªüi t·∫°o WebSocket
const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const chatSocket = new WebSocket(`${wsProtocol}${window.location.host}/ws/chat/${roomName}/`);


const chatLog = document.getElementById('chatBox');
const messageInput = document.getElementById('chat-message-input');
const imageInput = document.getElementById('chat-image-input');
const fileInput = document.getElementById('chat-file-input');
const messageSubmit = document.getElementById('chat-message-submit');
const endcallButton = document.getElementById('end-call-button');

// L·∫Øng nghe tin nh·∫Øn t·ª´ server
chatSocket.onmessage = function(event) {
    //t·∫°o bi·∫øn data ƒë·ªÉ l·∫•y d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c t·ª´ server
    const data = JSON.parse(event.data);
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† call_offer kh√¥ng
    if (data.type === "call_offer") {
        console.log("ƒë√¢y l√† share offer c·ªßa: " + senderUsername)
        video_container = document.getElementById("video-container")
        if(video_container.style.display == "none"){
            // G·ªçi h√†m hi·ªÉn th·ªã b·∫£ng ch·∫•p nh·∫≠p cu·ªôc g·ªçi 
            showOfferShare()
        }
        //signalingState cho bi·∫øt tr·∫°ng th√°i c·ªßa qu√° tr√¨nh ƒë√†m ph√°n (negotiation) gi·ªØa hai peer.
        // "stable" c√≥ nghƒ©a l√† kh√¥ng c√≥ qu√° tr√¨nh ƒë√†m ph√°n n√†o ƒëang di·ªÖn ra v√† k·∫øt n·ªëi ƒëang ·ªü tr·∫°ng th√°i ·ªïn ƒë·ªãnh
        if (peer.signalingState === "stable") {
            console.log("Nh·∫≠n offer t·ª´ peer, signalingState:", peer.signalingState);
            peer.setRemoteDescription(new RTCSessionDescription(data.offer))
            .then(() => peer.createAnswer())
            .then(answer => peer.setLocalDescription(answer).then(() => answer))
            .then(answer => {
                chatSocket.send(JSON.stringify({
                type: "call_answer",
                answer: answer,
                sender: senderUsername
                }));
                applyQueuedIceCandidates(); // √Åp d·ª•ng ICE candidate sau khi answer ƒë∆∞·ª£c thi·∫øt l·∫≠p
            })
            .catch(error => console.error("L·ªói x·ª≠ l√Ω call_offer:", error));
        } else {
            console.warn("Kh√¥ng x·ª≠ l√Ω offer v√¨ signalingState:", peer.signalingState);
        }
    }
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† share_offer kh√¥ng

    if (data.type === "share_offer") {
        console.log("ƒë√¢y l√† share offer c·ªßa: " + senderUsername)
        video_container = document.getElementById("video-container")
        if(video_container.style.display == "none"){
            showOfferShare()
        }
        if (peer.signalingState === "stable") {
            console.log("Nh·∫≠n offer t·ª´ peer, signalingState:", peer.signalingState);
            peer.setRemoteDescription(new RTCSessionDescription(data.offer))
            .then(() => peer.createAnswer())
            .then(answer => peer.setLocalDescription(answer).then(() => answer))
            .then(answer => {
                chatSocket.send(JSON.stringify({
                type: "call_answer",
                answer: answer,
                sender: senderUsername
                }));
                applyQueuedIceCandidates(); // √Åp d·ª•ng ICE candidate sau khi answer ƒë∆∞·ª£c thi·∫øt l·∫≠p
            })
            .catch(error => console.error("L·ªói x·ª≠ l√Ω call_offer:", error));
        } else {
            console.warn("Kh√¥ng x·ª≠ l√Ω offer v√¨ signalingState:", peer.signalingState);
        }
    }
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† call_answer kh√¥ng

    if (data.type === "call_answer") {
        if (peer.signalingState === "have-local-offer") {
            console.log("Nh·∫≠n answer t·ª´ peer, signalingState:", peer.signalingState);
            peer.setRemoteDescription(new RTCSessionDescription(data.answer))
            .then(() => applyQueuedIceCandidates())
            .catch(error => console.error("L·ªói setRemoteDescription v·ªõi answer:", error));
        } else {
            console.warn("Kh√¥ng x·ª≠ l√Ω answer v√¨ signalingState:", peer.signalingState);
        }
    }
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† ice_candidate kh√¥ng

    if (data.type === "ice_candidate") {
        const candidate = new RTCIceCandidate(data.candidate);
        if (peer.remoteDescription && peer.remoteDescription.type) {
            peer.addIceCandidate(candidate)
            .catch(error => console.error("L·ªói th√™m ICE candidate:", error));
        } else {
            iceCandidateQueue.push(candidate); // L∆∞u v√†o h√†ng ƒë·ª£i n·∫øu SDP ch∆∞a s·∫µn s√†ng
        }
    }
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† error kh√¥ng n·∫øu c√≥ th√¨ b√°o ra console

    if (data.type === "error") {
        console.error("L·ªói t·ª´ server:", data.message);
    }
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† end_connection kh√¥ng n·∫øu c√≥ th·ª±c hi·ªán k·∫øt th√∫c cu·ªôc g·ªçi

    if (data.type === "end_connection") {
        // ki·ªÉm tra username c·ªßa ng∆∞·ªùi nh·∫≠n v√† th·ª±c hi·ªán k·∫øt th√∫c cu·ªôc g·ªçi
        if(receiver.username == data.receiver){
            hideModal();
            endCall();
        }
    }
    // ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c c√≥ ph·∫£i l√† chat_message kh√¥ng 
    if (data.type === "chat_message") {
        // n·∫øu tin nh·∫Øn l√† r·ªóng v√† ko c√≥ ·∫£nh hay file k√®m theo th√¨ ng·∫Øt
        if(data.message == "" && !data.image && !data.file){
            return 
        }
        // N·∫øu c√≥ tin nh·∫Øn, file, ·∫£nh th√¨ hi·ªÉn th·ªã ra 
        else{
            const newMessage = `
                <div class="d-flex ${data.sender === sender.username ? 'justify-content-end' : 'justify-content-start'} mb-2">
                ${data.sender === sender.username
                    ? `<div class="text-end">
                        <p class="mb-1"><strong>${data.sender}:</strong></p>
                        ${data.image ? `<img src="${data.image}" class="img-fluid rounded mb-2" style="max-width: 400px; max-height:700px;">` : ''}
                        ${data.file ? `<a href="${data.file}" download class="d-block text-decoration-none text-primary mb-2">üìÇ T·∫£i t·ªáp ƒë√≠nh k√®m</a>` : ''}
                        ${data.message ? `<p class="p-2 bg-primary text-white rounded" style="word-wrap: break-word;">${data.message}</p>` : ''}
                    </div>`
                    : `<div class="d-flex align-items-start">
                        <img src="${data.avatar}" alt="Profile Picture" class="img-fluid rounded-circle" style="width: 30px; height: 30px; margin-right: 10px;">
                        <div>
                        <p class="mb-1"><strong>${data.sender}:</strong></p>
                        ${data.image ? `<img src="${data.image}" class="img-fluid rounded mb-2" style="max-width: 400px; max-height:700px;">` : ''}
                        ${data.file ? `<a href="${data.file}" download class="d-block text-decoration-none text-primary mb-2">üìÇ T·∫£i t·ªáp ƒë√≠nh k√®m</a>` : ''}
                        ${data.message ? `<p class="p-2 bg-light text-dark rounded" style="word-wrap: break-word;">${data.message}</p>` : ''}
                        </div>
                    </div>`}
                </div>
            `;
            chatLog.innerHTML += newMessage;
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }
};

// N√∫t k·∫øt th√∫c cu·ªôc g·ªçi
endcallButton.onclick = async function (e) {
    e.preventDefault();
    const formData = {
        type: "end_connection",
        sender: senderUsername,
        receiver: receiver.username
    };
    chatSocket.send(JSON.stringify(formData));
}

// G·ª≠i tin nh·∫Øn chat khi nh·∫•n "Send"
messageSubmit.onclick = async function (e) {
    // ngƒÉn s·ª± ki·ªán k√≠ch ho·∫°t
    e.preventDefault();
    // l·∫•y d·ªØ li·ªáu
    const message = messageInput.value.trim();
    const imageFile = imageInput.files[0];
    const otherFile = fileInput.files[0];
    // t·∫°o form d·ªØ li·ªáu
    const formData = {
        type: "chat_message",
        sender: senderUsername,
        message: message,
        image: null,
        file: null
    };
    // n·∫øu c√≥ image th√¨ chuy·ªÉn ƒë·ªïi ƒë·ªÉ c√≥ th·ªÉ g·ª≠i ƒëi
    if (imageFile) {
        formData.image = await convertImageToBase64(imageFile);
    }
    // n·∫øu c√≥ file th√¨ chuy·ªÉn ƒë·ªïi ƒë·ªÉ c√≥ th·ªÉ g·ª≠i ƒëi

    if (otherFile) {
        formData.file = await convertFileToBase64(otherFile);
    }

    chatSocket.send(JSON.stringify(formData));

    // t·∫£i l·∫°i c√°c tr∆∞·ªùng
    messageInput.value = '';
    imageInput.value = '';
    fileInput.value = '';
};
// H√†m chuy·ªÉn ƒë·ªïi ·∫£nh
async function convertImageToBase64(file) {
    return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    });
}
// H√†m chuy·ªÉn ƒë·ªïi file
async function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    });
}

chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};

chatSocket.onopen = function(e) {
    console.log('Chat socket opened');
};


{% comment %} video call {% endcomment %}
// H√†m b·∫Øt ƒë·∫ßu g·ªçi video 
async function startCall() {
    try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localStream = stream;
    localVideo.srcObject = stream;
    stream.getTracks().forEach(track => peer.addTrack(track, stream));

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    chatSocket.send(JSON.stringify({
        type: "call_offer",
        offer: offer,
        sender: senderUsername
    }));
    } catch (error) {
    console.error("L·ªói trong startCall:", error);
    }
}


{% comment %} chia s·∫Ω m√†n h√¨nh {% endcomment %}
// H√†m b·∫Øt ƒë·∫ßu chia s·∫Ω m√†n h√¨nh 

async function startShareScreen() {
    try {
        // L·∫•y d·ªØ li·ªáu t·ª´ m√†n h√¨nh thay v√¨ t·ª´ camera
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        localStream = stream;
        localVideo.srcObject = stream;

        stream.getTracks().forEach(track => peer.addTrack(track, stream));

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        chatSocket.send(JSON.stringify({
            type: "share_offer",
            offer: offer,
            sender: senderUsername
        }));
    } catch (error) {
        console.error("L·ªói trong startCall:", error);
    }
}

// H√†m k√©t th√∫c 

function endCall() {
    if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
    }
    peer.close();
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    location.reload();
}

</script>
{% endblock %}